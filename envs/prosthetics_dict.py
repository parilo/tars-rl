#!/usr/bin/env python

from osim.env import ProstheticsEnv
import numpy as np


class ProstheticsEnvWrap:

    def __init__(self, frame_skip=1, visualize=False):
        self.env = ProstheticsEnv(visualize=visualize)
        self.env.change_model(model='3D', prosthetic=True, difficulty=0, seed=25)
        self.frame_skip = frame_skip
        self.observation_shapes = [(275,)]
        self.action_size = 19

    def reset(self):
        self.time_step = 0
        self.total_reward = 0
        self.init_action = np.round(np.random.uniform(0, 1.0, size=self.action_size))
        obs = self.env.reset(project=False)
        return self.preprocess_obs(obs)

    def step(self, action):
        reward = 0
        for i in range(self.frame_skip):
            observation, r, done, info = self.env.step(action, project=False)
            reward += r*1e-2
            if done: break
        observation = self.preprocess_obs(observation)
        self.total_reward += reward
        self.time_step += 1
        return observation, reward, done, info

    def preprocess_obs(self, obs):

        acc_mult = 1e-1
        force_mult = 1e-3

        vec = []
        for key, values in obs["body_pos"].items():
            for v in values:
                vec.append(v)
        for key, values in obs["body_vel"].items():
            for v in values:
                vec.append(v)
        for key, values in obs["body_acc"].items():
            for v in values:
                vec.append(v * acc_mult)
        # 99

        for key, values in obs["body_pos_rot"].items():
            for v in values:
                vec.append(v)
        for key, values in obs["body_vel_rot"].items():
            for v in values:
                vec.append(v)
        for key, values in obs["body_acc_rot"].items():
            for v in values:
                vec.append(v * acc_mult)
        # 99

        for m_name, m_values in obs["muscles"].items():
            for key, value in m_values.items():
                vec.append(value * force_mult)
        # 19 * 4 = 76

        vec.extend(obs["forces"]["ankleSpring"])
        # 1

        # 275
        return vec

    def get_total_reward(self):
        return self.total_reward

    def get_random_action(self, resample=True):
        if resample:
            self.init_action = np.round(np.random.uniform(0, 1.0, size=self.action_size))
        return self.init_action







# {
#     "joint_pos": {
#         "ground_pelvis": [
#             1.0836485501022952,
#             0.5671926831969127,
#             -0.1574131006490415,
#             -0.4328051563930376,
#             0.8266579634118458,
#             0.14538912465275056
#         ],
#         "hip_r": [
#             -0.6353458700167279,
#             0.2458512628698423,
#             -3.3438744380634656e-15
#         ],
#         "knee_r": [
#             0.16535694131804746
#         ],
#         "ankle_r": [
#             -0.000478375194566314
#         ],
#         "hip_l": [
#             -0.6292289148521167,
#             0.45483838427281836,
#             -5.948921738763341e-15
#         ],
#         "knee_l": [
#             0.17991613617283672
#         ],
#         "ankle_l": [
#             -0.7073645842760895
#         ],
#         "subtalar_l": [],
#         "mtp_l": [],
#         "back": [
#             -0.0872665
#         ],
#         "back_0": []
#     },
#     "joint_vel": {
#         "ground_pelvis": [
#             1.7081817499228722,
#             0.47061264783416873,
#             1.3332888748699199,
#             -1.7496628197096518,
#             -1.106997504390145,
#             0.5160325431010758
#         ],
#         "hip_r": [
#             -0.033703079243317995,
#             -0.11195250171704578,
#             -1.4077866283659574e-14
#         ],
#         "knee_r": [
#             0.20960912175979202
#         ],
#         "ankle_r": [
#             -0.22488552985481494
#         ],
#         "hip_l": [
#             0.1653853190369195,
#             -0.7091650945751143,
#             -1.5903423354579518e-14
#         ],
#         "knee_l": [
#             0.05727467350539346
#         ],
#         "ankle_l": [
#             0.1558117077651397
#         ],
#         "subtalar_l": [],
#         "mtp_l": [],
#         "back": [
#             -1.8846054884876946e-15
#         ],
#         "back_0": []
#     },
#     "joint_acc": {
#         "ground_pelvis": [
#             4.630732647779427,
#             -6.26900213266584,
#             17.53221554550038,
#             -1.3367114708049608,
#             -8.558383831619198,
#             0.5982288511780991
#         ],
#         "hip_r": [
#             -18.811994447529813,
#             26.72411565807938,
#             -2.913225216616411e-13
#         ],
#         "knee_r": [
#             51.27737951506107
#         ],
#         "ankle_r": [
#             23.367860783576702
#         ],
#         "hip_l": [
#             11.066733584827965,
#             -19.200539440344247,
#             -5.222489107836736e-13
#         ],
#         "knee_l": [
#             -34.54533785567518
#         ],
#         "ankle_l": [
#             39.76126565646818
#         ],
#         "subtalar_l": [],
#         "mtp_l": [],
#         "back": [
#             9.237055564881302e-14
#         ],
#         "back_0": []
#     },
#     "body_pos": {
#         "pelvis": [
#             -0.4328051563930376,
#             0.8266579634118458,
#             0.14538912465275056
#         ],
#         "femur_r": [
#             -0.38846330064073475,
#             0.7093379068236798,
#             0.17008232514583121
#         ],
#         "pros_tibia_r": [
#             -0.3231641053333039,
#             0.4329026349367013,
#             -0.1048084528406713
#         ],
#         "pros_foot_r": [
#             -0.18637361387755397,
#             0.1695644273460904,
#             -0.41600188122607074
#         ],
#         "femur_l": [
#             -0.4545142779156621,
#             0.7739529820628195,
#             0.03097387661423648
#         ],
#         "tibia_l": [
#             -0.28859662720699253,
#             0.4170527059547121,
#             -0.005154541834622592
#         ],
#         "talus_l": [
#             -0.03899521226670416,
#             0.07140898954845143,
#             -0.06109696731541902
#         ],
#         "calcn_l": [
#             -0.0909612050993825,
#             0.03292573275952655,
#             -0.05666793403131619
#         ],
#         "toes_l": [
#             0.08228449780795015,
#             0.018362016476584475,
#             -0.09848217792229427
#         ],
#         "torso": [
#             -0.5475974118243253,
#             0.7749194477281605,
#             0.17586213054070077
#         ],
#         "head": [
#             -0.9302231297543206,
#             1.0311831161251066,
#             0.47657211081787026
#         ]
#     },
#     "body_vel": {
#         "pelvis": [
#             -1.7496628197096518,
#             -1.106997504390145,
#             0.5160325431010758
#         ],
#         "femur_r": [
#             -1.4419513963957744,
#             -0.9803923078538548,
#             0.564986637828992
#         ],
#         "pros_tibia_r": [
#             -1.022663177362405,
#             -1.0653210063046588,
#             0.7508862953073654
#         ],
#         "pros_foot_r": [
#             -0.5922973493647723,
#             -0.9604539208473958,
#             0.8513204303087081
#         ],
#         "femur_l": [
#             -1.7296877740166015,
#             -1.2481206046852908,
#             0.577250342255296
#         ],
#         "tibia_l": [
#             -0.9114112418540666,
#             -0.8507517537734423,
#             0.41147281121133056
#         ],
#         "talus_l": [
#             -0.12447982815061676,
#             -0.23859190486044635,
#             0.14030096334699532
#         ],
#         "calcn_l": [
#             -0.018321824365549855,
#             -0.3746291004555926,
#             0.20384795313892856
#         ],
#         "toes_l": [
#             -0.03003112745858516,
#             0.07780504674642824,
#             -0.002247104419492635
#         ],
#         "torso": [
#             -1.5955086253118247,
#             -1.361744931858511,
#             0.664211357631962
#         ],
#         "head": [
#             -1.9334763668845216,
#             -2.0568561246994355,
#             0.8265491504107879
#         ]
#     },
#     "body_acc": {
#         "pelvis": [
#             -1.3367114708049608,
#             -8.558383831619198,
#             0.5982288511780991
#         ],
#         "femur_r": [
#             0.110527250035101,
#             -6.700481235376098,
#             2.2458195683404756
#         ],
#         "pros_tibia_r": [
#             -6.594765580331963,
#             -6.264181086208736,
#             1.2239807035209007
#         ],
#         "pros_foot_r": [
#             3.9568159633441335,
#             5.747173063461258,
#             -3.639211904284235
#         ],
#         "femur_l": [
#             -0.15738996348866852,
#             -10.759982527391761,
#             1.598930567650875
#         ],
#         "tibia_l": [
#             5.370088978681267,
#             -5.587555328702775,
#             -1.5381659097803393
#         ],
#         "talus_l": [
#             -1.8372143437152075,
#             -7.5804128914535625,
#             -2.2996543683469
#         ],
#         "calcn_l": [
#             -0.45377267805470645,
#             -8.568240009402928,
#             -2.2853725216464467
#         ],
#         "toes_l": [
#             -1.787490553749917,
#             -4.253073095704528,
#             -3.399749228724343
#         ],
#         "torso": [
#             0.17191722228418016,
#             -9.216058497016997,
#             1.5346330534600592
#         ],
#         "head": [
#             -1.7550963142992784,
#             -10.28218780522337,
#             -2.083038874514118
#         ]
#     },
#     "body_pos_rot": {
#         "pelvis": [
#             0.4348417611250886,
#             0.4066283241509723,
#             0.9466581996311791
#         ],
#         "femur_r": [
#             0.6975979522632447,
#             0.46911041643126594,
#             0.19931791360899567
#         ],
#         "pros_tibia_r": [
#             0.6975979522632447,
#             0.46911041643126594,
#             0.36467485492704316
#         ],
#         "pros_foot_r": [
#             0.6975979522632447,
#             0.469110416431266,
#             0.3641964797324768
#         ],
#         "femur_l": [
#             -0.008322992610001636,
#             0.23142281037287527,
#             0.4590513253829709
#         ],
#         "tibia_l": [
#             -0.008322992610001636,
#             0.23142281037287527,
#             0.6389674615558075
#         ],
#         "talus_l": [
#             -0.008322992610001636,
#             0.23142281037287527,
#             -0.06839712272028187
#         ],
#         "calcn_l": [
#             -0.008322992610001636,
#             0.23142281037287527,
#             -0.06839712272028187
#         ],
#         "toes_l": [
#             -0.008322992610001636,
#             0.23142281037287527,
#             -0.06839712272028187
#         ],
#         "torso": [
#             0.4348417611250886,
#             0.4066283241509723,
#             0.8593916996311791
#         ],
#         "head": [
#             0.4348417611250886,
#             0.4066283241509723,
#             0.8593916996311791
#         ]
#     },
#     "body_vel_rot": {
#         "pelvis": [
#             -0.773402600093863,
#             0.9422596635090221,
#             2.4245131207599315
#         ],
#         "femur_r": [
#             -0.8846140222201572,
#             0.9064426954709591,
#             2.4202207344312883
#         ],
#         "pros_tibia_r": [
#             -0.7898512093541646,
#             0.7863402316092629,
#             2.563508526643277
#         ],
#         "pros_foot_r": [
#             -0.8915203791068205,
#             0.9151958176431496,
#             2.409777854987455
#         ],
#         "femur_l": [
#             -0.08919107911299184,
#             1.1912743591766888,
#             2.4138495840457543
#         ],
#         "tibia_l": [
#             -0.07605440908150937,
#             1.1917383422666528,
#             2.4695954434913276
#         ],
#         "talus_l": [
#             -0.04031702523139163,
#             1.1930005755225894,
#             2.6212481204853266
#         ],
#         "calcn_l": [
#             -0.04031702523139163,
#             1.1930005755225894,
#             2.6212481204853266
#         ],
#         "toes_l": [
#             -0.04031702523139163,
#             1.1930005755225894,
#             2.6212481204853266
#         ],
#         "torso": [
#             -0.7734026000938637,
#             0.9422596635090229,
#             2.4245131207599298
#         ],
#         "head": [
#             -0.7734026000938637,
#             0.9422596635090229,
#             2.4245131207599298
#         ]
#     },
#     "body_acc_rot": {
#         "pelvis": [
#             -17.312973873940432,
#             -0.09680453976487824,
#             14.579413578756819
#         ],
#         "femur_r": [
#             -1.306463707870105,
#             18.574665595925858,
#             -6.633202537857571
#         ],
#         "pros_tibia_r": [
#             22.29623634117681,
#             -10.450299945692269,
#             28.44011589202783
#         ],
#         "pros_foot_r": [
#             32.40947519533244,
#             -24.22174111151784,
#             44.392443477070124
#         ],
#         "femur_l": [
#             3.1705690293239472,
#             5.841446255026336,
#             19.001973177747143
#         ],
#         "tibia_l": [
#             -4.687552059124525,
#             5.598275872945098,
#             -14.636948075167043
#         ],
#         "talus_l": [
#             4.609809705440511,
#             6.020173287461298,
#             24.020297559532946
#         ],
#         "calcn_l": [
#             4.609809705440511,
#             6.020173287461298,
#             24.020297559532946
#         ],
#         "toes_l": [
#             4.609809705440511,
#             6.020173287461298,
#             24.020297559532946
#         ],
#         "torso": [
#             -17.3129738739404,
#             -0.096804539764917,
#             14.579413578756895
#         ],
#         "head": [
#             -17.3129738739404,
#             -0.096804539764917,
#             14.579413578756895
#         ]
#     },
#     "forces": {
#         "abd_r": [
#             2497.4189841237508
#         ],
#         "add_r": [
#             1391.6977788347742
#         ],
#         "hamstrings_r": [
#             1360.9344932364086
#         ],
#         "bifemsh_r": [
#             288.4222150038566
#         ],
#         "glut_max_r": [
#             1639.818865310603
#         ],
#         "iliopsoas_r": [
#             1512.9192971973248
#         ],
#         "rect_fem_r": [
#             1037.1735019674516
#         ],
#         "vasti_r": [
#             5286.344771662539
#         ],
#         "abd_l": [
#             2428.049923074364
#         ],
#         "add_l": [
#             935.0538470064841
#         ],
#         "hamstrings_l": [
#             1079.4727013274512
#         ],
#         "bifemsh_l": [
#             295.772562712676
#         ],
#         "glut_max_l": [
#             1389.4016377701623
#         ],
#         "iliopsoas_l": [
#             1311.3335212523862
#         ],
#         "rect_fem_l": [
#             1133.7902363285666
#         ],
#         "vasti_l": [
#             4680.8652274456235
#         ],
#         "gastroc_l": [
#             507.2613970118604
#         ],
#         "soleus_l": [
#             501.2467593936373
#         ],
#         "tib_ant_l": [
#             1067.9615374529183
#         ],
#         "ankleSpring": [
#             0.33251994863223555
#         ],
#         "pros_foot_r_0": [
#             0.0,
#             0.0,
#             0.0,
#             0.0,
#             0.0,
#             0.0,
#             0.0,
#             0.0,
#             0.0,
#             0.0,
#             0.0,
#             0.0,
#             0.0,
#             0.0,
#             0.0,
#             0.0,
#             0.0,
#             0.0
#         ],
#         "foot_l": [
#             20.25847276878258,
#             -89.71212519157817,
#             -16.95540800590369,
#             -9.248877600569257,
#             0.1718825348960894,
#             -8.935077228384731,
#             0.0,
#             0.0,
#             0.0,
#             0.0,
#             0.0,
#             0.0,
#             -20.25847276878258,
#             89.71212519157817,
#             16.95540800590369,
#             0.10249664449350271,
#             -0.7718138216506063,
#             1.1811736489409466,
#             -20.25847276878258,
#             89.71212519157817,
#             16.95540800590369,
#             0.10249664449350271,
#             -0.7718138216506063,
#             1.1811736489409466
#         ],
#         "HipLimit_r": [
#             96.34024703644967,
#             2.819533850652729
#         ],
#         "HipLimit_l": [
#             82.06723927150223,
#             2.270119462743648
#         ],
#         "KneeLimit_r": [
#             -192.22939892468162,
#             10.680282196837178
#         ],
#         "KneeLimit_l": [
#             -206.98910464630316,
#             13.559883430172864
#         ],
#         "AnkleLimit_r": [
#             0.0,
#             0.0
#         ],
#         "AnkleLimit_l": [
#             0.011398870293371525,
#             2.7044759869949007e-05
#         ],
#         "HipAddLimit_r": [
#             0.0,
#             0.0
#         ],
#         "HipAddLimit_l": [
#             0.0,
#             0.0
#         ]
#     },
#     "muscles": {
#         "abd_r": {
#             "activation": 0.5814139474315712,
#             "fiber_length": 0.07005450061338635,
#             "fiber_velocity": 0.002583514408561612,
#             "fiber_force": 2497.4189841237508
#         },
#         "add_r": {
#             "activation": 0.5516912157564648,
#             "fiber_length": 0.047106115917438886,
#             "fiber_velocity": 0.003559112904412055,
#             "fiber_force": 1410.0856877649962
#         },
#         "hamstrings_r": {
#             "activation": 0.4730933374450388,
#             "fiber_length": 0.040617525974746695,
#             "fiber_velocity": 0.012934115914813221,
#             "fiber_force": 1515.2525047367253
#         },
#         "bifemsh_r": {
#             "activation": 0.6250252317269861,
#             "fiber_length": 0.13506337408437197,
#             "fiber_velocity": -0.02261720015640642,
#             "fiber_force": 304.2378656680189
#         },
#         "glut_max_r": {
#             "activation": 0.5460817390072753,
#             "fiber_length": 0.12214383504162368,
#             "fiber_velocity": 0.0006064142273706014,
#             "fiber_force": 1639.8188653106029
#         },
#         "iliopsoas_r": {
#             "activation": 0.6272481116800634,
#             "fiber_length": 0.14817525374892274,
#             "fiber_velocity": -0.013327458661412415,
#             "fiber_force": 1522.138049679238
#         },
#         "rect_fem_r": {
#             "activation": 0.42498078172314996,
#             "fiber_length": 0.06714489710271501,
#             "fiber_velocity": 0.016104810304077115,
#             "fiber_force": 1042.2574212233546
#         },
#         "vasti_r": {
#             "activation": 0.7311438689050608,
#             "fiber_length": 0.0693811381585718,
#             "fiber_velocity": -0.01971213835738457,
#             "fiber_force": 5301.147254191971
#         },
#         "abd_l": {
#             "activation": 0.632944909947141,
#             "fiber_length": 0.07622689498724992,
#             "fiber_velocity": -0.024707126356282465,
#             "fiber_force": 2428.049923074364
#         },
#         "add_l": {
#             "activation": 0.4615049229664969,
#             "fiber_length": 0.03322927343999433,
#             "fiber_velocity": 0.04520544350977081,
#             "fiber_force": 960.3919719001507
#         },
#         "hamstrings_l": {
#             "activation": 0.568252959863019,
#             "fiber_length": 0.04015438162897836,
#             "fiber_velocity": -0.041192909625351985,
#             "fiber_force": 1205.2305942637686
#         },
#         "bifemsh_l": {
#             "activation": 0.6430561264277326,
#             "fiber_length": 0.13522336551164782,
#             "fiber_velocity": -0.023327579508218912,
#             "fiber_force": 311.9497098380167
#         },
#         "glut_max_l": {
#             "activation": 0.43665715067165284,
#             "fiber_length": 0.12382059841406863,
#             "fiber_velocity": 0.008278214773952382,
#             "fiber_force": 1389.4016377701623
#         },
#         "iliopsoas_l": {
#             "activation": 0.4684781474610316,
#             "fiber_length": 0.14752510248725662,
#             "fiber_velocity": 0.011107394967671427,
#             "fiber_force": 1319.3951761308547
#         },
#         "rect_fem_l": {
#             "activation": 0.5339368228599439,
#             "fiber_length": 0.06491654490821415,
#             "fiber_velocity": 0.0016485306829448333,
#             "fiber_force": 1139.7388887392867
#         },
#         "vasti_l": {
#             "activation": 0.6132869859366276,
#             "fiber_length": 0.06884713778745989,
#             "fiber_velocity": -0.004187450944792383,
#             "fiber_force": 4694.177270225558
#         },
#         "gastroc_l": {
#             "activation": 0.6375724439328908,
#             "fiber_length": 0.02040048621000009,
#             "fiber_velocity": -0.0774919517581416,
#             "fiber_force": 743.2707475892071
#         },
#         "soleus_l": {
#             "activation": 0.4056862342578523,
#             "fiber_length": 0.019302231944870248,
#             "fiber_velocity": 0.01091606912057006,
#             "fiber_force": 1869.1137083544738
#         },
#         "tib_ant_l": {
#             "activation": 0.6313703943234908,
#             "fiber_length": 0.08642233467701756,
#             "fiber_velocity": -0.028138742737594865,
#             "fiber_force": 1070.4816420112113
#         }
#     },
#     "markers": {},
#     "misc": {
#         "mass_center_pos": [
#             -0.5624698464283712,
#             0.7327622724181313
#         ],
#         "mass_center_vel": [
#             -1.4850465991243325,
#             -1.3881947947846693
#         ],
#         "mass_center_acc": [
#             -0.2807039295108426,
#             -8.563587585894787
#         ]
#     }
# }
